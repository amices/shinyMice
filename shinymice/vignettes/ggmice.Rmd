---
title: "ggmice"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{ggmice}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
# set-up environment
library(shinymice)
library(tidyverse)
# example dataset
dat <- mice::boys
# example mids object
imp <- mice::mice(dat, printFlag = FALSE)

# define mice theme
theme_mice <- function() {
  # move this outside of the function to unnecessary avoid re-running
  ggplot2::update_geom_defaults("point", list(
    shape = 21,
    size = 1.9,
    stroke = 1.1,
    alpha = 0.5
  ))
  ggplot2::update_geom_defaults("boxplot", list(
    size = 1
  ))
  ggplot2::update_geom_defaults("line", list(
    size = 1
  ))
  # the actual theme settings
  theme <- list(
    ggplot2::theme_classic(),
    ggplot2::theme(legend.position = "bottom"),
    ggplot2::scale_color_manual(
      values = c(
        "Observed" = mice:::mdc(1),
        "Missing" = mice:::mdc(2),
        "Imputed" = mice:::mdc(2)
      )
    ),
    ggplot2::scale_fill_manual(
      values = c(
        "Observed" = mice:::mdc(1),
        "Missing" = mice:::mdc(2),
        "Imputed" = mice:::mdc(2)
      )
    )
  )
  return(theme)
}
```

## Plot incomplete data

We can evaluate the missingness in the incomplete data using two plotting devices:

- histogram

- scatterplot


```{r}
# histogram/density plot
plot_conditional <- function(dat, x, z) {
  if (is.numeric(dat[[x]])) {
    geom <- ggplot2::geom_density(ggplot2::aes(x = .data[[x]], y = ..count.., color = conditional))
  } else {
    geom <-
      ggplot2::geom_bar(
        ggplot2::aes(x = .data[[x]], color = conditional),
        position = ggplot2::position_dodge(),
        fill = "white"
      )
  }
  dat %>%
    dplyr::mutate(conditional = factor(
      is.na(.data[[z]]),
      levels = c(TRUE, FALSE),
      labels = c("Missing", "Observed")
    )) %>%
    ggplot2::remove_missing(., vars = x) %>%
    ggplot2::ggplot() +
    geom +
    theme_mice() +
    ggplot2::labs(color = paste0("Variable '", z, "' is:"))
}

plot_conditional(dat, x = "age", z = "hc")
plot_conditional(dat, x = "reg", z = "hc")
```

```{r}
# scatterplot
plot_bivariate <- function(dat, x, y) {
  # set NA value and scale for variable 'x'
  if (is.numeric(dat[[x]])) {
    NA_x <-
      min(dat[[x]], na.rm = TRUE) - .5 * sd(dat[[x]], na.rm = TRUE)
    scale_x <- ggplot2::scale_x_continuous(expand = c(0.01, 0.01),
                                           limits = c(NA_x, max(dat[[x]])))
  } else {
    NA_x <- "NA"
    scale_x <-
      ggplot2::scale_x_discrete(expand = c(0.01, 0.01),
                                limits = c("NA", levels(dat[[x]])))
  }
  
  # set NA value and scale for variable 'y'
  if (is.numeric(dat[[y]])) {
    NA_y <-
      min(dat[[y]], na.rm = TRUE) - .5 * sd(dat[[y]], na.rm = TRUE)
    scale_y <- ggplot2::scale_y_continuous(expand = c(0.01, 0.01),
                                           limits = c(NA_y, max(dat[[y]])))
  } else {
    NA_y <- "NA"
    scale_y <-
      ggplot2::scale_y_discrete(expand = c(0.01, 0.01),
                                limits = c("NA", levels(dat[[y]])))
  }
  
  # add geom for NAs in the 'x' space
  if (any(is.na(dat[[x]]))) {
    geom_x <- ggplot2::geom_point(
      position = ggplot2::position_jitter(width = 0.1, height = 0.1),
      color = mice:::mdc(2),
      shape = 4,
      mapping = ggplot2::aes(x = NA_x, y = .data[[y]]),
      data = dat[is.na(dat[[x]]),]
    )
  } else {
    geom_x <- NULL
  }
  
  # add geom for NAs in the 'y' space
  if (any(is.na(dat[[y]]))) {
    geom_y <- ggplot2::geom_point(
      position = ggplot2::position_jitter(width = 0.1, height = 0.1),
      color = mice:::mdc(2),
      shape = 4,
      mapping = ggplot2::aes(x = .data[[x]], y = NA_y),
      data = dat[is.na(dat[[y]]),]
    )
  } else{
    geom_y <- NULL
  }
  
  # add geom for NAs in the 'x' and 'y' space
  if (any(is.na(dat[[x]]) & is.na(dat[[y]]))) {
    geom_xy <- ggplot2::geom_point(
      position = ggplot2::position_jitter(width = 0.1, height = 0.1),
      color = mice:::mdc(2),
      shape = 4,
      mapping = ggplot2::aes(x = NA_x, y = NA_y),
      data = dat[is.na(dat[[x]]) & is.na(dat[[y]]),]
    )
  } else{
    geom_xy <- NULL
  }
  
  # plot
  p <- dat %>% ggplot2::ggplot() +
    ggplot2::geom_point(
      ggplot2::aes(x = .data[[x]], y = .data[[y]]),
      position = ggplot2::position_jitter(width = 0.1, height = 0.1),
      color = mice::mdc(1)
    ) +
    geom_x +
    geom_y +
    geom_xy +
    theme_mice() +
    scale_x +
    scale_y
  
  # output
  return(p)
}
plot_bivariate(dat, x = "age", y = "hc")
plot_bivariate(dat, x = "reg", y = "hc")
```

## Plot missingness

- md pattern

- fluxplot

```{r}
# md pattern

```

```{r}
# plot in- and outflux of incomplete data
plot_flux <- function(dat){
  flx <- mice::flux(dat)
  p <- flx %>% ggplot2::ggplot() +
    ggplot2::geom_text(
      ggplot2::aes(x = influx, y = outflux, label = rownames(flx))
    ) +
    geom_abline(intercept = 1, slope = -1, linetype = "dashed") +
    lims(x = c(0,1), y = c(0,1)) +
    theme_classic()
  return(p)
}
plot_flux(flx)
```
## Plot convergence

```{r}

# make chain means and variances tidy
preprocess_thetas <- function(imp) {
  d <- imp$chainMean %>%
    dplyr::na_if(., "NaN") %>%
    as.data.frame() %>%
    dplyr::mutate(var = row.names(.), theta = "Chain means") %>%
    rbind(
      .,
      imp$chainVar %>%
        sqrt() %>%
        as.data.frame(.) %>%
        dplyr::mutate(var = row.names(.), theta = "Chain standard deviations")
    ) %>%
    tidyr::pivot_longer(-c(var, theta)) %>%
    cbind(.it = as.integer(1:imp$iteration),
          .imp = as.factor(rep(1:imp$m, each = imp$iteration)))
  return(d)
}
# test
trace_dat <- preprocess_thetas(imp)

trace_one_variable <- function(d, x) {
  # plot one variable
  p <- d[d$var == x,] %>%
    ggplot2::ggplot() +
    ggplot2::geom_line(ggplot2::aes(x = .it, y = value, color = .imp)) +
    ggplot2::facet_wrap( ~ theta, scales = "free", ncol = 2) +
    ggplot2::theme_classic() +
    ggplot2::theme(
      strip.background = element_rect(colour = "white"),
      strip.text = element_text(face = "bold", size = 11)
    ) +
    ggplot2::labs(x = "Iteration",
                  y = paste0("Variable: '", x, "'"),
                  color = "Imputation")
  # show message to user when variable is completely observed
  if (all(is.na(p$data$value))) {
    p <-
      p + ggplot2::geom_text(ggplot2::aes(
        x = median(as.numeric(d$.imp)),
        y = 0,
        label = "No \n imputations \n to show"
      ),
      color = "grey")
  }
  return(p)
}
#test
trace_one_variable(trace_dat, x = "hgt")
trace_one_variable(trace_dat, x = "age")
```


## Plot imputed data

We need to preprocess the `mids` object to make it `tidy`. Then we can plot the imputed data using one of four plotting devices:

- stripplot

- bwplot/boxplot

- densityplot

- xyplot/scatterplot

```{r}
# preprocess
prepare_plotting <- function(mids, x, y = NULL) {
  imps <- mids$imp[[x]] %>%
    dplyr::mutate(.id = row.names(.)) %>%
    tidyr::pivot_longer(
      cols = 1:mids$m,
      names_to = ".imp",
      values_to = x,
      names_transform = list(.imp = as.numeric)
    )
  
  # preprocess incomplete data
  d <-
    mids$data %>%
    dplyr::mutate(.id = rownames(.)) %>%
    .[c(x, y, ".id")] %>%
    cbind(.imp = 0)
  
  # combine incomplete and imputed data
    cd <- d %>%
      dplyr::bind_rows(., imps) %>%
      dplyr::mutate(imputed = ifelse(.imp > 0, 'Imputed', 'Observed'))
  
  return(cd)
}

# test
x = "hc"
y = "reg"
plot_dat <- prepare_plotting(mids = imp, x = x, y = y)
plot_dat2 <- prepare_plotting(mids = imp, x = y, y = x)
a <- dplyr::full_join(plot_dat, plot_dat2)
```

Now plot the prepared data

```{r}
# stripplot
m = 5
geom_stripplot <- function(x, m, ...) {
  p <- list(
    ggplot2::geom_jitter(
      ggplot2::aes(
        x = as.factor(.data$.imp),
        y = .data[[x]],
        color = .data$imputed
      ),
      height = 0,
      width = 0.25, 
      ...
    ),
    ggplot2::scale_x_discrete(limits = as.character(0:m)),
    ggplot2::labs(
      x = "Imputation (0 = observed data)",
      y = paste0("Variable: '", x, "'"),
      color = "",
      fill = "",
      size = ""
    )
  )
  return(p)
}

plot_dat %>%
  ggplot2::ggplot() +
  geom_stripplot(x, m)
```

Now add a mice theme

```{r}

plot_dat %>%
  ggplot2::ggplot() +
  geom_stripplot(x, m) +
  theme_mice()
```

Do the same for a boxplot

```{r}
geom_bwplot <- function(x, m){
  list(
    ggplot2::geom_boxplot(
      ggplot2::aes(
        x = as.factor(.data$.imp),
        y = .data[[x]],
        color = .data$imputed
      ),
      width = 0.5
    ),
    ggplot2::scale_x_discrete(limits = as.character(0:m)),
    ggplot2::labs(
      x = "Imputation (0 = observed data)",
      y = paste0("Variable: '", x, "'"),
      color = "",
      fill = "",
      size = ""
    ))
}

plot_dat %>% 
  ggplot2::ggplot() +
  geom_bwplot(x, m = imp$m) + 
  theme_mice()

# try to combine this with the stripplot??
plot_dat %>%
  ggplot2::ggplot() +
  geom_bwplot(x, m) + 
  geom_stripplot(x, m, alpha = 0.1) +
  theme_mice()

```

And something similar for density plots:

```{r}
geom_densityplot <- function(x, m){
  list(ggplot2::geom_density(
    ggplot2::aes(
    x = .data[[x]],
    group = .data$.imp,
    color = .data$imputed,
    size = .data$imputed)),
    ggplot2::scale_size_manual(values = c(0.5, 1) %>% setNames(c("Imputed", "Observed")))
)}


plot_dat %>% na.omit() %>% 
  ggplot2::ggplot() +
  geom_densityplot(x, m = imp$m) + 
  theme_mice()


```
Note the addition of `na.omit()` to make sure that categorical variables don't get an NA category.

```{r}
# At some point, try to do this for histograms too? See https://github.com/amices/shinyMice/blob/Enhancements/R/gg.barplot.R

# geom_densityplot <- function(x, m){
#   list(ggplot2::geom_density(
#     ggplot2::aes(
#     x = .data[[x]],
#     group = .data$.imp,
#     color = .data$imputed,
#     size = .data$imputed)),
#     ggplot2::scale_size_manual(values = c(0.5, 1) %>% setNames(c("Imputed", "Observed")))
# )}
# 
# plot_dat %>% 
#   ggplot2::ggplot() +
#   geom_densityplot(x, m = imp$m) + 
#   theme_mice()
```

Now for something different: xyplots!

```{r}
geom_xyplot <- function(x, y, m) {
  list(ggplot2::geom_point(
    ggplot2::aes(
    x = .data[[x]],
    y = .data[[y]],
    color = .data$imputed
    )))}

plot_dat %>% na.omit() %>% 
  ggplot2::ggplot() +
  geom_densityplot(x, m = imp$m) + 
  theme_mice()
```

